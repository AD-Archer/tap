name: Update RustySound Cask

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "RustySound release tag (e.g. v0.1.67)"
        required: false
        type: string
  repository_dispatch:
    types: [rustysound-release]

permissions:
  contents: write

concurrency:
  group: update-rustysound-cask
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4

      - name: Update cask version and checksum
        id: update
        run: |
          RELEASE_TAG=""
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            RELEASE_TAG='${{ github.event.client_payload.version }}'
            echo "Using dispatched release tag: ${RELEASE_TAG}"
          elif [[ -n '${{ inputs.release_tag }}' ]]; then
            RELEASE_TAG='${{ inputs.release_tag }}'
            echo "Using manual release tag input: ${RELEASE_TAG}"
          fi

          if [[ -n "${RELEASE_TAG}" ]]; then
            export RELEASE_TAG
          fi

          bash .github/scripts/update-rustysound-cask.sh

      - name: Commit and push changes
        if: steps.update.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Casks/rustysound.rb
          git commit -m "rustysound ${{ steps.update.outputs.version }}"
          git push

      - name: No changes
        if: steps.update.outputs.changed != 'true'
        run: echo "RustySound cask already up to date."
